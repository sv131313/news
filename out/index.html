<!DOCTYPE html>
<html>
<head>
    <title>RSS Feed Aggregator - 24h News</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/dayjs.min.js"></script>
    <style>
        .feed-container {
            max-width: 800px;
            margin: 0 auto;
            font-family: monospace;
            white-space: pre-wrap;
            padding: 20px;
        }
        .controls {
            margin-bottom: 20px;
        }
        button {
            padding: 8px 16px;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="feed-container">
        <div class="controls">
            <button onclick="copyToClipboard()">Copy to Clipboard</button>
            <button onclick="downloadCSV()">Download CSV</button>
        </div>
        <div id="feeds"></div>
    </div>

    <script>
        const RSS_FEEDS = [
            'https://www.nacion.com/arc/outboundfeeds/rss/?outputType=xml',
            'https://www.diarioextra.com/rss',
            'https://www.crhoy.com/feed/',
            'https://observador.cr/feed/',
            'https://ticotimes.net/feed',
            'https://qcostarica.com/feed/'
        ];

        function parseRSS(text) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(text, 'text/xml');
            const items = doc.querySelectorAll('item');
            
            return Array.from(items).map(item => ({
                title: item.querySelector('title')?.textContent?.replace(/[\n\r;]/g, ' ').trim() || '',
                link: item.querySelector('link')?.textContent?.trim() || '',
                description: item.querySelector('description')?.textContent?.replace(/[\n\r;]/g, ' ').trim() || '',
                pubDate: item.querySelector('pubDate')?.textContent || '',
            }));
        }

        async function fetchFeed(url) {
            try {
                const response = await fetch('https://corsproxy.io/?' + encodeURIComponent(url));
                const text = await response.text();
                return parseRSS(text);
            } catch (error) {
                console.error(`Error fetching ${url}:`, error);
                return [];
            }
        }

        function isWithinLast24Hours(dateStr) {
            const itemDate = new Date(dateStr);
            const now = new Date();
            const hoursDiff = (now - itemDate) / (1000 * 60 * 60);
            return hoursDiff <= 24;
        }

        function formatDate(dateStr) {
            return dayjs(dateStr).format('YYYY-MM-DD HH:mm:ss');
        }

        function formatAsCSV(item) {
            // Ensure each field is properly escaped for CSV format
            const fields = [
                formatDate(item.pubDate),
                item.title,
                item.description,
                item.link
            ].map(field => field.replace(/"/g, '""')); // Escape quotes

            return fields.join(';');
        }

        async function aggregateFeeds() {
            const feedsDiv = document.getElementById('feeds');
            feedsDiv.textContent = 'Loading feeds...';

            try {
                const feedPromises = RSS_FEEDS.map(url => fetchFeed(url));
                const feedsResults = await Promise.all(feedPromises);
                
                const allItems = feedsResults
                    .flat()
                    .filter(item => isWithinLast24Hours(item.pubDate))
                    .sort((a, b) => new Date(b.pubDate) - new Date(a.pubDate));

                if (allItems.length === 0) {
                    feedsDiv.textContent = 'No items found in the last 24 hours';
                    return;
                }

                // Create header
                const header = 'Date;Title;Description;Link\n';
                
                // Format all items
                const formattedItems = allItems.map(formatAsCSV).join('\n');
                
                // Combine header and items
                feedsDiv.textContent = header + formattedItems;

            } catch (error) {
                feedsDiv.textContent = `Error loading feeds: ${error.message}`;
            }
        }

        function copyToClipboard() {
            const feedsDiv = document.getElementById('feeds');
            const text = feedsDiv.textContent;
            
            navigator.clipboard.writeText(text).then(
                () => alert('Copied to clipboard!'),
                () => alert('Failed to copy to clipboard')
            );
        }

        function downloadCSV() {
            const feedsDiv = document.getElementById('feeds');
            const text = feedsDiv.textContent;
            
            const blob = new Blob([text], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', `rss_feeds_${dayjs().format('YYYY-MM-DD_HH-mm')}.csv`);
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // Initialize
        aggregateFeeds();
    </script>
</body>
</html>